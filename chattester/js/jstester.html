<!DOCTYPE html>
<html>

<head>
    <title></title>
    <script src="centrifuge.js"></script>
    <script src="sha256.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
</head>

<body>
    <script type="text/javascript">
    //get this from server
    var secret = "secret";
    var user = "1003";
    var info = "";
    //get this from server
    var channel = "hede#1001,1002,1003";
    var timestamp = parseInt(new Date().getTime() / 1000).toString();

    var hmacBody = user + timestamp;
    var shaObj = new jsSHA("SHA-256", "TEXT");
    shaObj.setHMACKey(secret, "TEXT");
    shaObj.update(hmacBody);
    var token = shaObj.getHMAC("HEX");

    var centrifuge = new Centrifuge({
        url: 'http://localhost:8000/connection/websocket',
        user: "1003",
        timestamp: timestamp,
        token: token
    });

    var callbacks = {
        "message": function(message) {
            if (message.data.userId == user) {
                return;
            }

            $("<p>" + message.data.text + "</p>").appendTo("#messages")

            var d = $('#messages');
            d.scrollTop(d.prop("scrollHeight"));
        },
        "join": function(message) {},
        "leave": function(message) {},
        "subscribe": function(context) {},
        "error": function(errContext) {},
        "unsubscribe": function(context) {}
    }

    centrifuge.subscribe(channel, callbacks);
    centrifuge.connect();

    $(function() {
        $("#btnSend").click(function() {
            var channel = "hede#1001,1002,1003";
            var url = "http://localhost:1234/broadcastToChatRoom?userId=" + 1003 + "&channel=" + encodeURIComponent(channel) + "&msg=" + $("#txtMsg").val()
            $.get(url, function(data) {});
        });
    });
    </script>
    <div id="messages" style="line-height:0.1;height:500px;width:300px;border:1px solid black;overflow-y: scroll;"></div>
    <div>
        <input type="text" id="txtMsg">
        <input type="button" id="btnSend" value="Send">
    </div>
</body>

</html>
